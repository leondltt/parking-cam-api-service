name: Mirror Repository to GCP Source Repository

on:
  push:
    branches:
      - main # Substitua pelo nome da branch que deseja observar
permissions: 
  contents: write

jobs:
  mirror-to-remote:
    runs-on: ubuntu-latest

    steps:
    - name: Get External IP
      run: |
        EXTERNAL_IP=$(curl -s https://ipinfo.io/ip)
        echo "O endereço IP externo é: $EXTERNAL_IP"

    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        ref: main

    - name: Set up SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CLOUD_BUILD_PRIVATE }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2022 -H source.developers.google.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    # ssh://leonardo.lauretti@santodigital.com.br@source.developers.google.com:2022/p/apostaganha-staging/r/test-cloud-build
    - name: Push to Remote
      run: |
        git push --mirror ssh://leonardo.lauretti@santodigital.com.br@source.developers.google.com:2022/p/apostaganha-staging/r/test-cloud-build

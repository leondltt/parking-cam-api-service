name: Mirror Repository to GCP Source Repository

on:
  push:
    branches:
      - main # Substitua pelo nome da branch que deseja observar

jobs:
  mirror-to-remote:
    runs-on: ubuntu-latest

    steps:
    - name: Get External IP
      run: |
        EXTERNAL_IP=$(curl -s https://ipinfo.io/ip)
        echo "O endereço IP externo é: $EXTERNAL_IP"

    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.CLOUD_BUILD_PRIVATE }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -p 2022 -H source.developers.google.com >> ~/.ssh/known_hosts
        chmod 644 ~/.ssh/known_hosts

    - name: Clonar repositório de destino
      run: |
        git clone ssh://leonardo.lauretti@santodigital.com.br@source.developers.google.com:2022/p/apostaganha-staging/r/test-cloud-build dest
        cd dest
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git checkout main

    - name: Sincronizar repositório
      run: |
        rsync -av --exclude=".git" ../ dest/
        cd dest
        git add .
        git commit -m "Sincronização a partir da branch main"
        git push -u origin main
